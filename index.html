<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>3D Fishing Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
html,body{margin:0;padding:0;overflow:hidden;background:black;touch-action:none}

/* UI */
#money{
 position:fixed;bottom:10px;right:10px;
 color:white;font-size:18px;
 background:rgba(0,0,0,.5);
 padding:6px 10px;border-radius:6px
}
#book{
 position:fixed;top:10px;left:10px;
 font-size:28px;cursor:pointer;
 z-index:10
}
#rules{
 position:fixed;top:50%;left:50%;
 transform:translate(-50%,-50%);
 width:85%;max-width:420px;
 background:rgba(0,0,0,.9);
 color:white;padding:20px;
 border-radius:12px;
 display:none;
 z-index:20
}
#rules button{
 margin-top:12px;padding:6px 14px;
 font-size:16px
}
#msg{
 position:fixed;top:50%;left:50%;
 transform:translate(-50%,-50%);
 color:white;font-size:22px;
 display:none;text-shadow:2px 2px 5px black
}

/* Controls */
#joystick{position:fixed;bottom:120px;left:20px;width:110px;height:110px;background:rgba(255,255,255,.15);border-radius:50%}
#stick{position:absolute;left:30px;top:30px;width:50px;height:50px;background:white;border-radius:50%}
#jump{position:fixed;bottom:120px;right:20px;width:80px;height:80px;border-radius:50%}

/* Inventory */
#inventory{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);display:flex;gap:6px}
.slot{width:42px;height:42px;border:2px solid white;color:white;font-size:9px;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.5)}
.slot.active{border-color:yellow}

/* SHOP */
#shop{
 position:fixed;
 top:50%;left:50%;
 transform:translate(-50%,-50%);
 background:rgba(0,0,0,.9);
 color:white;
 padding:20px;
 border-radius:12px;
 display:none;
 z-index:50;
 text-align:center
}
#shop button{
 margin:6px;
 padding:6px 14px;
 font-size:16px
}

/* LOGIN */
#login{
 position:fixed;
 top:50%;left:50%;
 transform:translate(-50%,-50%);
 background:rgba(0,0,0,.9);
 color:white;
 padding:20px;
 border-radius:12px;
 z-index:100;
 text-align:center;
}
#login input{
 padding:6px 10px;
 font-size:16px;
 margin-bottom:12px;
}
#login button{
 padding:6px 14px;
 font-size:16px;
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login">
 <h2>Login</h2>
 <input type="text" id="username" placeholder="Enter username"><br>
 <button id="loginBtn">Login</button>
</div>

<div id="book">üìò</div>

<div id="rules">
 <h2>Fishing Game Rules</h2>
 <p>
 üéÆ <b>Controls</b><br>
 ‚Ä¢ Move with left joystick<br>
 ‚Ä¢ Swipe screen to look<br>
 ‚Ä¢ Jump with jump button<br><br>

 üé£ <b>Fishing</b><br>
 ‚Ä¢ Equip Rod from inventory<br>
 ‚Ä¢ Hold screen 2 seconds to cast<br>
 ‚Ä¢ Wait for fish<br>
 ‚Ä¢ Tap fast to catch it<br><br>

 üêü <b>Fish Chances</b><br>
 ‚Ä¢ Clownfish ‚Äì ~25%<br>
 ‚Ä¢ Tuna ‚Äì ~25%<br>
 ‚Ä¢ Shark ‚Äì ~50%<br>
 ‚Ä¢ Pufferfish ‚Äì 1/3<br>
 ‚Ä¢ Sea Turtle ‚Äì 1/5<br>
 ‚Ä¢ Manta Ray ‚Äì 1/25<br>
 ‚Ä¢ Megalodon ‚Äì 1/50<br><br>

 üí∞ <b>Selling</b><br>
 ‚Ä¢ Tap fish once to preview<br>
 ‚Ä¢ Tap twice to sell
 </p>
 <button onclick="rules.style.display='none'">CLOSE</button>
</div>

<div id="money">$0</div>
<div id="msg"></div>

<div id="joystick"><div id="stick"></div></div>
<button id="jump">JUMP</button>
<div id="inventory"></div>

<!-- SHOP -->
<div id="shop">
 <h3>Shop</h3>
 <button id="buySunRod">Buy Sun Rod ($1000)</button><br>
 <button id="buyBait">Buy 1 Bait ($25)</button><br><br>
 <button onclick="shop.style.display='none'">CLOSE</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/controls/OrbitControls.js"></script>
<script>
/* ===== GLOBAL VARIABLES ===== */
let scene, camera, renderer, player, rod, velocityY=0, grounded=true;
let yaw=0, pitch=0, moveX=0, moveZ=0;
let looking=false, lastX=0, lastY=0;
let joy=false, center={};
let money=0;
let inventory=["Rod","","","","","","","",""];
let selected=0;
let fishing=false, holding=false, holdTime=0, taps=0;
let preview=null;
let username=null;

const prices={Clownfish:5,Tuna:10,Shark:25,Pufferfish:25,SeaTurtle:50,MantaRay:500,Megalodon:1000};

/* ===== THREE.JS SCENE ===== */
scene = new THREE.Scene();
scene.background = new THREE.Color(0x87CEEB);

camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, .1, 1000);
renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(devicePixelRatio);
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0xffffff, .7));
const sun = new THREE.DirectionalLight(0xffffff, 1);
sun.position.set(10,20,10);
scene.add(sun);

/* UNDERGROUND */
const ground = new THREE.Mesh(
 new THREE.PlaneGeometry(2000,2000),
 new THREE.MeshStandardMaterial({color:0x1e90ff, side:THREE.DoubleSide})
);
ground.rotation.x = -Math.PI/2;
ground.position.y=-1;
scene.add(ground);

/* ISLAND */
const island = new THREE.Mesh(
 new THREE.CylinderGeometry(18,22,2,64),
 new THREE.MeshStandardMaterial({color:0x2e8b57, roughness:.8, metalness:.1})
);
island.position.y=1;
scene.add(island);

/* TREES */
function addTree(x,z){
 const trunk = new THREE.Mesh(new THREE.CylinderGeometry(.3,.5,3,12), new THREE.MeshStandardMaterial({color:0x8b4513}));
 trunk.position.set(x,1.5,z);
 scene.add(trunk);
 for(let i=0;i<3;i++){
   const leaves = new THREE.Mesh(new THREE.ConeGeometry(1.5-i*.3,1.5,8), new THREE.MeshStandardMaterial({color:0x228b22}));
   leaves.position.set(x,3+i*.5,z);
   scene.add(leaves);
 }
}
for(let i=0;i<6;i++) addTree(Math.random()*12-6, Math.random()*12-6);

/* ORB (SHOP) */
const orb = new THREE.Mesh(
 new THREE.SphereGeometry(.4,16,16),
 new THREE.MeshStandardMaterial({color:0xffff00,emissive:0xffff00,emissiveIntensity:.7})
);
orb.position.set(3,1.8,3);
scene.add(orb);

/* PLAYER */
player = new THREE.Object3D();
player.position.set(0,3,0);
player.add(camera);
scene.add(player);

/* ===== UI ELEMENTS ===== */
const invEl = document.getElementById("inventory");
const msg = document.getElementById("msg");
const shop = document.getElementById("shop");
const moneyEl = document.getElementById("money");

/* ===== INVENTORY FUNCTIONS ===== */
function parseStack(item){
 if(!item) return {name:"", count:0};
 const match=item.match(/^(.+)x(\d+)$/);
 if(match) return {name:match[1], count:parseInt(match[2])};
 return {name:item, count:1};
}

function renderInv(){
 invEl.innerHTML="";
 inventory.forEach((it,i)=>{
   const d=document.createElement("div");
   d.className="slot"+(i===selected?" active":"");
   d.textContent=it;
   d.onclick=()=>slotTap(i);
   invEl.appendChild(d);
 });
}

function slotTap(i){
 selected=i;
 renderInv();
 updateRod();
}

/* ADD ITEM */
function addItem(item){
 for(let i=0;i<inventory.length;i++){
   const {name,count}=parseStack(inventory[i]);
   if(name===item){
     inventory[i]=name+"x"+(count+1);
     renderInv();
     return;
   }
 }
for(let i=0;i<inventory.length;i++){
 if(!inventory[i]){
   inventory[i]=item;
   renderInv();
   return;
 }
}
alert("Inventory full!");
}

/* UPDATE ROD */
function updateRod(){
 if(["Rod","Sun Rod"].includes(inventory[selected])){
   if(!rod){
     rod = new THREE.Mesh(new THREE.CylinderGeometry(.02,.02,1), new THREE.MeshStandardMaterial({color:inventory[selected]==="Sun Rod"?0xffcc00:0x8b4513}));
     rod.position.set(.3,-.4,-1);
     rod.rotation.z=Math.PI/4;
     camera.add(rod);
   } else {
     rod.material.color.set(inventory[selected]==="Sun Rod"?0xffcc00:0x8b4513);
   }
 } else if(rod){
   camera.remove(rod);
   rod=null;
 }
}

/* ===== TOUCH CONTROLS ===== */
document.addEventListener("touchstart", e=>{
 const t = e.touches[0];
 if(!e.target.closest(".slot") && e.target.id!=="joystick" && e.target.id!=="stick" && e.target.id!=="jump" && e.target.id!=="book"){
   if(fishing){ taps++; }
   else { looking=true; lastX=t.clientX; lastY=t.clientY; }
 }
}, {passive:false});

document.addEventListener("touchmove", e=>{
 const t=e.touches[0];
 if(looking){
   yaw -= (t.clientX-lastX)*0.004;
   pitch -= (t.clientY-lastY)*0.004;
   pitch=Math.max(-1.4, Math.min(1.4, pitch));
   lastX = t.clientX;
   lastY = t.clientY;
 }
 if(joy){
   let dx = t.clientX - center.x;
   let dy = t.clientY - center.y;
   dx=Math.max(-40,Math.min(40,dx));
   dy=Math.max(-40,Math.min(40,dy));
   stick.style.left=30+dx+"px";
   stick.style.top=30+dy+"px";
   moveX = dx/40;
   moveZ = dy/40;
 }
}, {passive:false});

document.addEventListener("touchend", ()=>{
 looking=false;
 joy=false;
 stick.style.left="30px";
 stick.style.top="30px";
 moveX=0; moveZ=0;
 holdTime=0;
 holding=false;
});

/* JOYSTICK */
joystick.addEventListener("touchstart", ()=>{
 joy=true;
 const r=joystick.getBoundingClientRect();
 center={x:r.left+r.width/2, y:r.top+r.height/2};
});

/* JUMP */
jump.addEventListener("touchstart", ()=>{
 if(grounded){ velocityY=.18; grounded=false; }
});

/* ORB CLICK ‚Üí SHOP */
const raycaster = new THREE.Raycaster();
const touchVec = new THREE.Vector2();
document.addEventListener("touchstart", e=>{
 touchVec.x=(e.touches[0].clientX/innerWidth)*2-1;
 touchVec.y=-(e.touches[0].clientY/innerHeight)*2+1;
 raycaster.setFromCamera(touchVec,camera);
 if(raycaster.intersectObject(orb).length){
   shop.style.display="block";
 }
});

/* ===== SHOP BUTTONS ===== */
buySunRod.onclick = ()=>{
 if(money<1000) return alert("Not enough money");
 for(let i=0;i<inventory.length;i++){
   if(inventory[i]==="Rod"){ inventory[i]="Sun Rod"; money-=1000; moneyEl.textContent="$"+money; renderInv(); return; }
 }
for(let i=0;i<inventory.length;i++){
 if(!inventory[i]){ inventory[i]="Sun Rod"; money-=1000; moneyEl.textContent="$"+money; renderInv(); return; }
}
alert("Inventory full!");
};

buyBait.onclick = ()=>{
 if(money<25) return alert("Not enough money");
 for(let i=0;i<inventory.length;i++){
   if(!inventory[i]){ inventory[i]="Bait"; money-=25; moneyEl.textContent="$"+money; renderInv(); return; }
}
alert("Inventory full!");
};

/* ===== FISHING ===== */
function randomFish(){
 const r=Math.random();
 if(r<0.02) return "Megalodon";
 else if(r<0.04) return "MantaRay";
 else if(r<0.24) return "SeaTurtle";
 else if(r<0.57) return "Pufferfish";
 else if(r<0.82) return "Tuna";
 else if(r<0.92) return "Clownfish";
 else return "Shark";
}

function startFishing(){
 fishing=true;
 msg.style.display="block";
 msg.textContent="Waiting for fish...";
 setTimeout(()=>{
   const fish = randomFish();
   msg.textContent = fish+"! TAP!";
   taps=0;
   setTimeout(()=>{
     if(taps>=10){
       msg.textContent="Caught "+fish+"!";
       addItem(fish);
     } else msg.textContent="Fish escaped!";
     setTimeout(()=>{ msg.style.display="none"; fishing=false; },2000);
   },5000);
 },500);
}

/* BOOK */
book.onclick = ()=> rules.style.display="block";

/* ===== LOGIN ===== */
const loginDiv = document.getElementById("login");
const usernameInput = document.getElementById("username");
const loginBtn = document.getElementById("loginBtn");

function loadPlayerData(name){
 const data=localStorage.getItem("fishingGame_"+name);
 if(data){
   const parsed=JSON.parse(data);
   money=parsed.money||0;
   inventory.splice(0,inventory.length,...parsed.inventory||inventory);
   selected=parsed.selected||0;
 }
moneyEl.textContent="$"+money;
renderInv();
updateRod();
}

function savePlayerData(){
 if(!username) return;
 localStorage.setItem("fishingGame_"+username, JSON.stringify({money,inventory,selected}));
}

loginBtn.onclick=()=>{
 const name=usernameInput.value.trim();
 if(!name) return alert("Enter a username");
 username=name;
 loadPlayerData(username);
 loginDiv.style.display="none";
 savePlayerData();
};

/* ===== GAME LOOP ===== */
function animate(){
 requestAnimationFrame(animate);
 updateRod();

 camera.rotation.order="YXZ";
 camera.rotation.y=yaw;
 camera.rotation.x=pitch;

 const f=new THREE.Vector3(Math.sin(yaw),0,Math.cos(yaw));
 const r=new THREE.Vector3(f.z,0,-f.x);
 player.position.add(f.multiplyScalar(moveZ*.15));
 player.position.add(r.multiplyScalar(moveX*.15));

 velocityY -= 0.01;
 player.position.y += velocityY;
 if(player.position.y <=3){ player.position.y=3; velocityY=0; grounded=true; }

 if(holding && !fishing){
   holdTime += 0.016;
   if(holdTime>=2){ startFishing(); holding=false; }
 }

 renderer.render(scene, camera);
}
animate();

/* Auto-save every 5 seconds */
setInterval(savePlayerData,5000);
</script>
</body>
</html>
