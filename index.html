<script>
/* ======================================================
   3D FISHING GAME â€“ FULL READY SCRIPT (PASTE & RUN)
====================================================== */

/* ---------- SCENE ---------- */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);

const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(devicePixelRatio);
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0xffffff, 0.7));
const sun = new THREE.DirectionalLight(0xffffff, 1);
sun.position.set(10,20,10);
scene.add(sun);

/* ---------- WATER ---------- */
const water = new THREE.Mesh(
  new THREE.PlaneGeometry(2000,2000),
  new THREE.MeshStandardMaterial({
    color:0x1e90ff,
    transparent:true,
    opacity:0.85
  })
);
water.rotation.x = -Math.PI/2;
water.position.y = 0;
scene.add(water);

/* ---------- ISLAND ---------- */
const island = new THREE.Mesh(
  new THREE.CylinderGeometry(18,22,2,64),
  new THREE.MeshStandardMaterial({color:0x2e8b57})
);
island.position.y = 1;
scene.add(island);

/* ---------- PLAYER ---------- */
const player = new THREE.Object3D();
scene.add(player);
player.position.set(0,3,0);
player.add(camera);

let yaw=0, pitch=0, velocityY=0, grounded=true;

/* ---------- CAMERA LOOK ---------- */
let looking=false,lastX=0,lastY=0;
addEventListener("touchstart",e=>{
 if(e.target.closest("#inventory,#joystick,#jump,#book,#shop")) return;
 looking=true;
 lastX=e.touches[0].clientX;
 lastY=e.touches[0].clientY;
});
addEventListener("touchmove",e=>{
 if(!looking) return;
 yaw-=(e.touches[0].clientX-lastX)*0.004;
 pitch-=(e.touches[0].clientY-lastY)*0.004;
 pitch=Math.max(-1.4,Math.min(1.4,pitch));
 lastX=e.touches[0].clientX;
 lastY=e.touches[0].clientY;
});
addEventListener("touchend",()=>looking=false);

/* ---------- MOVEMENT ---------- */
let moveX=0, moveZ=0, joy=false, center={};
joystick.addEventListener("touchstart",()=>{
 joy=true;
 const r=joystick.getBoundingClientRect();
 center={x:r.left+r.width/2,y:r.top+r.height/2};
});
addEventListener("touchmove",e=>{
 if(!joy) return;
 let dx=e.touches[0].clientX-center.x;
 let dy=e.touches[0].clientY-center.y;
 dx=Math.max(-40,Math.min(40,dx));
 dy=Math.max(-40,Math.min(40,dy));
 stick.style.left=30+dx+"px";
 stick.style.top=30+dy+"px";
 moveX=dx/40;
 moveZ=dy/40;
});
addEventListener("touchend",()=>{
 joy=false;
 stick.style.left="30px";
 stick.style.top="30px";
 moveX=moveZ=0;
});

jump.addEventListener("touchstart",()=>{
 if(grounded){velocityY=0.18; grounded=false;}
});

/* ---------- INVENTORY ---------- */
let money=0;
const prices={Clownfish:5,Tuna:10,Shark:25,Pufferfish:25,SeaTurtle:50,MantaRay:500,Megalodon:1000};
let inventory=["Rod","","","","","","","",""];
let selected=0, lastTap=0;
const inventoryDiv=document.getElementById("inventory");

function parse(item){
 if(!item) return {n:"",c:0};
 const m=item.match(/^(.+)x(\d+)$/);
 return m?{n:m[1],c:+m[2]}:{n:item,c:1};
}

function renderInv(){
 inventoryDiv.innerHTML="";
 inventory.forEach((it,i)=>{
  const d=document.createElement("div");
  d.className="slot"+(i===selected?" active":"");
  d.textContent=it;
  d.onclick=()=>tapSlot(i);
  inventoryDiv.appendChild(d);
 });
}

function tapSlot(i){
 selected=i;
 renderInv();
 updateRod();
 const {n,c}=parse(inventory[i]);
 if(!prices[n]) return;
 const now=Date.now();
 if(now-lastTap<500){
  money+=prices[n]*c;
  inventory[i]="";
  updateMoney();
  renderInv();
 }
 lastTap=now;
}

function addItem(name){
 for(let i=0;i<inventory.length;i++){
  const p=parse(inventory[i]);
  if(p.n===name && p.c<99){
   inventory[i]=name+"x"+(p.c+1);
   renderInv(); return true;
  }
 }
 for(let i=0;i<inventory.length;i++){
  if(!inventory[i]){
   inventory[i]=name;
   renderInv(); return true;
  }
 }
 alert("Inventory full!");
 return false;
}
renderInv();

/* ---------- ROD ---------- */
let rod=null;
function updateRod(){
 if(["Rod","Sun Rod"].includes(inventory[selected])){
  if(!rod){
   rod=new THREE.Mesh(
    new THREE.CylinderGeometry(0.02,0.02,1),
    new THREE.MeshStandardMaterial({color:inventory[selected]==="Sun Rod"?0xffcc00:0x8b4513})
   );
   rod.position.set(0.3,-0.4,-1);
   rod.rotation.z=Math.PI/4;
   camera.add(rod);
  }
 }else if(rod){
  camera.remove(rod);
  rod=null;
 }
}

/* ---------- FISHING ---------- */
let fishing=false, cooldown=false;

const fishTable=[
 {n:"Clownfish",t:6},
 {n:"Tuna",t:8},
 {n:"Shark",t:12},
 {n:"Pufferfish",t:10},
 {n:"SeaTurtle",t:14},
 {n:"MantaRay",t:16},
 {n:"Megalodon",t:20}
];

function nearWater(){
 const d=Math.sqrt(player.position.x**2+player.position.z**2);
 return d>22;
}

function consumeBait(){
 for(let i=0;i<inventory.length;i++){
  if(inventory[i]==="Bait"){
   inventory[i]="";
   renderInv();
   return true;
  }
 }
 return false;
}

addEventListener("touchstart",e=>{
 if(fishing||cooldown) return;
 if(!["Rod","Sun Rod"].includes(inventory[selected])) return;
 if(e.target.closest("#inventory,#joystick,#jump,#shop,#book")) return;
 if(!nearWater()) return alert("Fish near water!");
 if(!consumeBait()) return alert("You need bait!");

 fishing=true;
 const fish=fishTable[Math.floor(Math.random()*fishTable.length)];
 let taps=0;

 function spawn(){
  if(taps>=fish.t){
   addItem(fish.n);
   fishing=false;
   cooldown=true;
   setTimeout(()=>cooldown=false,1500);
   return;
  }
  const b=document.createElement("button");
  b.textContent="TAP!";
  b.style.position="fixed";
  b.style.left=Math.random()*(innerWidth-120)+"px";
  b.style.top=Math.random()*(innerHeight-60)+"px";
  document.body.appendChild(b);

  const fail=setTimeout(()=>{
   document.body.removeChild(b);
   fishing=false;
  },800);

  b.onclick=()=>{
   clearTimeout(fail);
   document.body.removeChild(b);
   taps++;
   spawn();
  };
 }
 setTimeout(spawn,800);
});

/* ---------- MONEY ---------- */
function updateMoney(){
 document.getElementById("money").textContent="$"+money;
}
updateMoney();

/* ---------- LOOP ---------- */
function animate(){
 requestAnimationFrame(animate);

 camera.rotation.order="YXZ";
 camera.rotation.y=yaw;
 camera.rotation.x=pitch;

 const f=new THREE.Vector3(Math.sin(yaw),0,Math.cos(yaw));
 const r=new THREE.Vector3(f.z,0,-f.x);
 player.position.add(f.multiplyScalar(moveZ*0.15));
 player.position.add(r.multiplyScalar(moveX*0.15));

 velocityY-=0.01;
 player.position.y+=velocityY;
 if(player.position.y<=3){
  player.position.y=3;
  velocityY=0;
  grounded=true;
 }

 renderer.render(scene,camera);
}
animate();
</script>
