<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>3D Fishing Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
html,body{margin:0;padding:0;overflow:hidden;background:black;touch-action:none}

/* UI */
#money{
 position:fixed;bottom:10px;right:10px;
 color:white;font-size:18px;
 background:rgba(0,0,0,.5);
 padding:6px 10px;border-radius:6px
}
#book{
 position:fixed;top:10px;left:10px;
 font-size:28px;cursor:pointer;
 z-index:10
}
#rules{
 position:fixed;top:50%;left:50%;
 transform:translate(-50%,-50%);
 width:85%;max-width:420px;
 background:rgba(0,0,0,.9);
 color:white;padding:20px;
 border-radius:12px;
 display:none;
 z-index:20
}
#msg{
 position:fixed;top:50%;left:50%;
 transform:translate(-50%,-50%);
 color:white;font-size:22px;
 display:none;text-shadow:2px 2px 5px black
}

/* Controls */
#joystick{position:fixed;bottom:120px;left:20px;width:110px;height:110px;background:rgba(255,255,255,.15);border-radius:50%}
#stick{position:absolute;left:30px;top:30px;width:50px;height:50px;background:white;border-radius:50%}
#jump{position:fixed;bottom:120px;right:20px;width:80px;height:80px;border-radius:50%}

/* INVENTORY */
#inventory{
 position:fixed;
 bottom:10px;
 left:50%;
 transform:translateX(-50%);
 display:flex;
 gap:6px;
 max-width:90%;
 padding:6px;
 background:rgba(0,0,0,.3);
 border-radius:6px;
 overflow-x:auto
}
.slot{
 width:42px;height:42px;
 border:2px solid white;
 font-size:9px;
 color:white;
 display:flex;
 align-items:center;
 justify-content:center;
 background:rgba(0,0,0,.5);
 flex:0 0 auto
}
.slot.active{border-color:yellow}

/* SHOP */
#shop{
 position:fixed;
 top:50%;left:50%;
 transform:translate(-50%,-50%);
 background:rgba(0,0,0,.9);
 color:white;
 padding:20px;
 border-radius:12px;
 display:none;
 z-index:50;
 text-align:center
}

/* LOGIN */
#login{
 position:fixed;
 top:50%;left:50%;
 transform:translate(-50%,-50%);
 background:rgba(0,0,0,.9);
 color:white;
 padding:20px;
 border-radius:12px;
 z-index:100;
 text-align:center
}
</style>
</head>
<body>

<div id="login">
 <h2>Login</h2>
 <input id="username" placeholder="Username"><br>
 <button id="loginBtn">Login</button>
</div>

<div id="book">ðŸ“˜</div>
<div id="money">$0</div>
<div id="msg"></div>

<div id="joystick"><div id="stick"></div></div>
<button id="jump">JUMP</button>
<div id="inventory"></div>

<div id="shop">
 <h3>Shop</h3>
 <button id="buySunRod">Buy Sun Rod ($1000)</button><br><br>
 <button onclick="shop.style.display='none'">CLOSE</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script>
/* ===== SCENE ===== */
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x87CEEB);

const camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,.1,1000);
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0xffffff,.7));
const sun=new THREE.DirectionalLight(0xffffff,1);
sun.position.set(10,20,10);
scene.add(sun);

/* WATER */
const water=new THREE.Mesh(
 new THREE.PlaneGeometry(2000,2000),
 new THREE.MeshStandardMaterial({color:0x1e90ff,side:THREE.DoubleSide})
);
water.rotation.x=-Math.PI/2;
water.position.y=-1;
scene.add(water);

/* ISLAND */
const island=new THREE.Mesh(
 new THREE.CylinderGeometry(18,22,2,64),
 new THREE.MeshStandardMaterial({color:0x2e8b57})
);
island.position.y=1;
scene.add(island);

/* PLAYER */
const player=new THREE.Object3D();
player.position.set(0,3,0);
player.add(camera);
scene.add(player);

let yaw=0,pitch=0,vy=0,grounded=true;

/* CAMERA LOOK */
let looking=false,lastX=0,lastY=0;
addEventListener("touchstart",e=>{
 if(e.target.closest(".slot"))return;
 looking=true;
 lastX=e.touches[0].clientX;
 lastY=e.touches[0].clientY;
});
addEventListener("touchmove",e=>{
 if(!looking)return;
 yaw-=(e.touches[0].clientX-lastX)*.004;
 pitch-=(e.touches[0].clientY-lastY)*.004;
 pitch=Math.max(-1.4,Math.min(1.4,pitch));
 lastX=e.touches[0].clientX;
 lastY=e.touches[0].clientY;
});
addEventListener("touchend",()=>looking=false);

/* MOVEMENT */
let mx=0,mz=0;
joystick.addEventListener("touchmove",e=>{
 const r=joystick.getBoundingClientRect();
 mx=(e.touches[0].clientX-(r.left+r.width/2))/40;
 mz=(e.touches[0].clientY-(r.top+r.height/2))/40;
});
joystick.addEventListener("touchend",()=>mx=mz=0);

jump.onclick=()=>{if(grounded){vy=.18;grounded=false;}};

/* ===== FISH MODELS (PREVIEW SYSTEM) ===== */
let previewFish=null;

function createFishModel(name){
 let geo,color;
 switch(name){
  case "Clownfish": geo=new THREE.SphereGeometry(.25,12,12); color=0xff9933; break;
  case "Tuna": geo=new THREE.CylinderGeometry(.15,.25,.8,8); color=0x6666ff; break;
  case "Shark": geo=new THREE.ConeGeometry(.4,1,8); color=0x888888; break;
  case "Pufferfish": geo=new THREE.SphereGeometry(.35,10,10); color=0xffff66; break;
  case "SeaTurtle": geo=new THREE.BoxGeometry(.6,.2,.8); color=0x228833; break;
  case "MantaRay": geo=new THREE.PlaneGeometry(1,.6); color=0x333333; break;
  case "Megalodon": geo=new THREE.ConeGeometry(.6,1.6,10); color=0x444444; break;
 }
 return new THREE.Mesh(geo,new THREE.MeshStandardMaterial({color}));
}
 /* ===== INVENTORY SYSTEM ===== */
let money=0;
const prices={
 Clownfish:5,
 Tuna:10,
 Shark:25,
 Pufferfish:25,
 SeaTurtle:50,
 MantaRay:500,
 Megalodon:1000
};

let inventory=["Rod","","","","","","","",""];
let selected=0;
const inv=document.getElementById("inventory");
let lastTap=0;

function parseStack(item){
 if(!item) return {name:"",count:0};
 const m=item.match(/^(.+)x(\d+)$/);
 return m?{name:m[1],count:+m[2]}:{name:item,count:1};
}

function renderInv(){
 inv.innerHTML="";
 inventory.forEach((it,i)=>{
  const d=document.createElement("div");
  d.className="slot"+(i===selected?" active":"");
  d.textContent=it;
  d.onclick=()=>slotTap(i);
  inv.appendChild(d);
 });
}
renderInv();

/* ===== FISH PREVIEW ===== */
function showFish(name){
 if(previewFish) camera.remove(previewFish);
 previewFish=createFishModel(name);
 previewFish.position.set(0,-0.2,-1.2);
 camera.add(previewFish);
}

/* ===== SLOT TAP ===== */
function slotTap(i){
 const {name,count}=parseStack(inventory[i]);
 selected=i;
 renderInv();

 if(!name || name==="Rod" || name==="Sun Rod") return;

 const now=Date.now();
 if(now-lastTap<500){
  money+=prices[name]*count;
  inventory[i]="";
  document.getElementById("money").textContent="$"+money;
  if(previewFish){camera.remove(previewFish);previewFish=null;}
  renderInv();
 }else{
  showFish(name);
  msg.style.display="block";
  msg.textContent=name+" (double tap to sell)";
  setTimeout(()=>msg.style.display="none",1000);
 }
 lastTap=now;
}

/* ===== ROD ===== */
let rod=null;
function updateRod(){
 if(inventory[selected]==="Rod"||inventory[selected]==="Sun Rod"){
  if(!rod){
   rod=new THREE.Mesh(
    new THREE.CylinderGeometry(.02,.02,1),
    new THREE.MeshStandardMaterial({color:inventory[selected]==="Sun Rod"?0xffcc00:0x8b4513})
   );
   rod.position.set(.3,-.4,-1);
   rod.rotation.z=Math.PI/4;
   camera.add(rod);
  }
 }else if(rod){
  camera.remove(rod);
  rod=null;
 }
}

/* ===== SHOP ===== */
const raycaster=new THREE.Raycaster();
const touchVec=new THREE.Vector2();
const orb=new THREE.Mesh(
 new THREE.SphereGeometry(.4,16,16),
 new THREE.MeshStandardMaterial({color:0xffff00,emissive:0xffff00})
);
orb.position.set(3,1.8,3);
scene.add(orb);

addEventListener("touchstart",e=>{
 touchVec.x=(e.touches[0].clientX/innerWidth)*2-1;
 touchVec.y=-(e.touches[0].clientY/innerHeight)*2+1;
 raycaster.setFromCamera(touchVec,camera);
 if(raycaster.intersectObject(orb).length) shop.style.display="block";
});

buySunRod.onclick=()=>{
 if(money<1000) return alert("Not enough money");
 for(let i=0;i<inventory.length;i++){
  if(inventory[i]==="Rod"){inventory[i]="Sun Rod";break;}
  if(inventory[i]===""){inventory[i]="Sun Rod";break;}
 }
 money-=1000;
 document.getElementById("money").textContent="$"+money;
 renderInv();
};

/* ===== FISHING ===== */
let holding=false,hold=0,fishing=false;

addEventListener("touchstart",()=>{
 if(inventory[selected]==="Rod"||inventory[selected]==="Sun Rod"){
  if(!fishing){holding=true;hold=0;}
 }
});
addEventListener("touchend",()=>holding=false);

function randomFish(){
 const r=Math.random();
 if(r<1/50) return "Megalodon";
 if(r<1/25) return "MantaRay";
 if(r<1/5) return "SeaTurtle";
 if(r<1/3) return "Pufferfish";
 if(r<0.58) return "Tuna";
 if(r<0.83) return "Clownfish";
 return "Shark";
}

function startFishing(){
 fishing=true;
 msg.style.display="block";
 msg.textContent="Casting...";
 setTimeout(()=>{
  const fish=randomFish();
  msg.textContent="Caught "+fish+"!";
  addFish(fish);
  fishing=false;
  setTimeout(()=>msg.style.display="none",1500);
 },1200);
}

function addFish(f){
 for(let i=0;i<inventory.length;i++){
  if(inventory[i]===""){inventory[i]=f;renderInv();return;}
 }
 alert("Inventory full");
}

/* ===== LOGIN / SAVE ===== */
const loginDiv=document.getElementById("login");
const usernameInput=document.getElementById("username");
const loginBtn=document.getElementById("loginBtn");
let username=null;

loginBtn.onclick=()=>{
 username=usernameInput.value.trim();
 if(!username) return;
 const data=localStorage.getItem("fish_"+username);
 if(data){
  const p=JSON.parse(data);
  money=p.money;
  inventory=p.inventory;
 }
 document.getElementById("money").textContent="$"+money;
 renderInv();
 loginDiv.style.display="none";
};

setInterval(()=>{
 if(username){
  localStorage.setItem("fish_"+username,JSON.stringify({money,inventory}));
 }
},5000);

/* ===== LOOP ===== */
function animate(){
 requestAnimationFrame(animate);

 updateRod();

 camera.rotation.order="YXZ";
 camera.rotation.y=yaw;
 camera.rotation.x=pitch;

 const f=new THREE.Vector3(Math.sin(yaw),0,Math.cos(yaw));
 const r=new THREE.Vector3(f.z,0,-f.x);
 player.position.add(f.multiplyScalar(-mz*.15));
 player.position.add(r.multiplyScalar(mx*.15));

 vy-=.01;
 player.position.y+=vy;
 if(player.position.y<=3){player.position.y=3;vy=0;grounded=true;}

 if(holding&&!fishing){
  hold+=.016;
  if(hold>2){holding=false;startFishing();}
 }

 if(previewFish) previewFish.rotation.y+=.03;

 renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>

